name: Deploy to Production

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set lowercase image name
        id: image
        run: echo "name=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ steps.image.outputs.name }}
          GITHUB_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: GITHUB_TOKEN,REGISTRY,IMAGE_NAME,GITHUB_ACTOR
          script: |
            set -e
            
            # Login to registry
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
            
            # Pull new image
            docker pull ${REGISTRY}/${IMAGE_NAME}:latest
            
            # Navigate to deployment directory
            DEPLOY_DIR="/root/shivambhardwaj.com"
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            
            # Copy docker-compose.yml from repo (or use existing)
            # For now, we'll use docker-compose if available, fallback to docker run
            
            # Use docker-compose if available, otherwise fallback
            if command -v docker-compose &> /dev/null || docker compose version &> /dev/null; then
              # Stop old container
              docker compose down antimony-labs 2>/dev/null || docker-compose down antimony-labs 2>/dev/null || true
              
              # Start new container
              docker compose up -d antimony-labs 2>/dev/null || docker-compose up -d antimony-labs || {
                # Fallback if compose file doesn't exist
                docker stop antimony-labs || true
                docker rm antimony-labs || true
                docker run -d \
                  --name antimony-labs \
                  --restart always \
                  --network web-network \
                  -p 127.0.0.1:3000:3000 \
                  -e LEPTOS_SITE_ADDR=0.0.0.0:3000 \
                  -e LEPTOS_ENV=PROD \
                  ${REGISTRY}/${IMAGE_NAME}:latest
              }
            else
              # Fallback to direct docker run
              docker stop antimony-labs || true
              docker rm antimony-labs || true
              
              # Create network if it doesn't exist
              docker network create web-network 2>/dev/null || true
              
              docker run -d \
                --name antimony-labs \
                --restart always \
                --network web-network \
                -p 127.0.0.1:3000:3000 \
                -e LEPTOS_SITE_ADDR=0.0.0.0:3000 \
                -e LEPTOS_ENV=PROD \
                ${REGISTRY}/${IMAGE_NAME}:latest
            fi
            
            # Cleanup unused images
            docker image prune -f
            
            echo "‚úÖ Deployment complete!"
            echo "üåê Service available via Cloudflare Tunnel at shivambhardwaj.com"
